<section style="padding:16px; max-width:900px; margin:auto">
  <h2>游닄 Libros</h2>

  <!-- Mensajes globales -->
  <div *ngIf="mensajeOk" style="margin:8px 0; padding:8px; border-radius:4px; background:#d1fae5;">
    {{ mensajeOk }}
  </div>
  <div *ngIf="mensajeError" style="margin:8px 0; padding:8px; border-radius:4px; background:#fee2e2;">
    {{ mensajeError }}
  </div>

  <!-- 游댍 Filtros -->
  <div style="display:flex; gap:8px; margin:12px 0; align-items:center; flex-wrap:wrap">
    <input [(ngModel)]="search" name="search" placeholder="游댍 Buscar por t칤tulo o autor" />
    <select [(ngModel)]="filterCategoriaId" name="filterCategoriaId">
      <option value="">Todas las categor칤as</option>
      <option *ngFor="let c of categorias" [value]="c.id">{{ c.nombre }}</option>
    </select>
    <button type="button" (click)="search=''; filterCategoriaId='';">Limpiar filtros</button>
  </div>

  <!-- ================= FORMULARIO REACTIVO ================= -->
  <h3 style="margin-top:12px;">
    {{ editando ? 'Editar libro' : 'Agregar libro' }}
  </h3>

  <form [formGroup]="formLibro"
        (ngSubmit)="guardar()"
        style="display:grid; grid-template-columns: 1fr 1fr 120px 1fr 130px; gap:8px; align-items:flex-start; margin:12px 0;">

    <!-- id oculto -->
    <input type="hidden" formControlName="id" />

    <!-- T칈TULO -->
    <div style="display:flex; flex-direction:column;">
      <input formControlName="titulo" placeholder="T칤tulo" />
      <small *ngIf="titulo?.invalid && (titulo?.touched || titulo?.dirty)" style="color:#dc2626;">
        <span *ngIf="titulo?.errors?.['required']">El t칤tulo es obligatorio.</span>
        <span *ngIf="titulo?.errors?.['minlength']">M칤nimo 3 caracteres.</span>
      </small>
    </div>

    <!-- AUTOR -->
    <div style="display:flex; flex-direction:column;">
      <input formControlName="autor" placeholder="Autor" />
      <small *ngIf="autor?.invalid && (autor?.touched || autor?.dirty)" style="color:#dc2626;">
        <span *ngIf="autor?.errors?.['required']">El autor es obligatorio.</span>
        <span *ngIf="autor?.errors?.['minlength']">M칤nimo 3 caracteres.</span>
      </small>
    </div>

    <!-- A칌O -->
    <div style="display:flex; flex-direction:column;">
      <input formControlName="anio" type="number" placeholder="A침o" />
      <small *ngIf="anio?.invalid && (anio?.touched || anio?.dirty)" style="color:#dc2626;">
        <span *ngIf="anio?.errors?.['required']">El a침o es obligatorio.</span>
        <span *ngIf="anio?.errors?.['min']">A침o m칤nimo 1900.</span>
        <span *ngIf="anio?.errors?.['max']">El a침o no puede ser mayor al actual.</span>
      </small>
    </div>

    <!-- CATEGOR칈A -->
    <div style="display:flex; flex-direction:column;">
      <select formControlName="categoriaId">
        <option value="">-- Categor칤a --</option>
        <option *ngFor="let c of categorias" [value]="c.id">{{ c.nombre }}</option>
      </select>
      <small *ngIf="categoriaId?.invalid && (categoriaId?.touched || categoriaId?.dirty)" style="color:#dc2626;">
        Selecciona una categor칤a.
      </small>
    </div>

    <!-- BOTONES -->
    <div style="display:flex; gap:4px; justify-content:flex-end;">
      <button type="submit">
        {{ editando ? 'Actualizar' : 'Agregar' }}
      </button>
      <button type="button" (click)="cancelarEdicion()">Limpiar</button>
    </div>
  </form>

  <hr style="margin:16px 0;">

  <!-- ================= LISTA ================= -->
  <table border="1" cellpadding="6" style="border-collapse:collapse; width:100%">
    <thead>
      <tr>
        <th>T칤tulo</th>
        <th>Autor</th>
        <th>A침o</th>
        <th>Categor칤a</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let l of librosFiltrados; trackBy: trackById">
        <td>{{ l.titulo }}</td>
        <td>{{ l.autor }}</td>
        <td style="text-align:center">{{ l.anio }}</td>
        <td style="text-align:center">
          {{ getNombreCategoria(l.categoriaId) }}
        </td>
        <td style="text-align:center">{{ l.estado | estadoLibro }}</td>
        <td style="white-space:nowrap; text-align:center">
          <a [routerLink]="['/libros', l.id]">Ver detalle</a>
          <button type="button" (click)="editar(l)" style="margin-left:4px;">Editar</button>
          <button type="button" (click)="borrar(l.id)" style="margin-left:4px;">Eliminar</button>
        </td>
      </tr>
    </tbody>
  </table>

  <p *ngIf="libros.length > 0 && librosFiltrados.length === 0"
     style="opacity:.7; margin-top:8px">
    No hay resultados que coincidan con el filtro.
  </p>
</section>
