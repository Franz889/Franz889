<section style="padding:24px 16px; max-width:1100px; margin:auto">

  <!-- T√≠tulo -->
  <header style="margin-bottom:12px;">
    <h2 style="font-size:24px; margin:0 0 4px; display:flex; align-items:center; gap:8px;">
      <span style="font-size:22px;">üìö</span>
      <span>Libros</span>
    </h2>
    <p style="margin:0; font-size:13px; opacity:.8;">
      Administra los libros de tu biblioteca: agrega, edita, filtra y consulta el detalle.
    </p>
  </header>

  <!-- Mensajes globales -->
  <div *ngIf="mensajeOk"
       style="margin:8px 0; padding:8px 10px; border-radius:4px; background:#e8f5e9; border:1px solid #c8e6c9; font-size:13px;">
    ‚úÖ {{ mensajeOk }}
  </div>
  <div *ngIf="mensajeError"
       style="margin:8px 0; padding:8px 10px; border-radius:4px; background:#ffebee; border:1px solid #ffcdd2; font-size:13px;">
    ‚ö†Ô∏è {{ mensajeError }}
  </div>

  <!-- üîé Filtros -->
  <section style="
    display:flex;
    gap:8px;
    margin:14px 0;
    align-items:center;
    flex-wrap:wrap;
    padding:10px 12px;
    border-radius:6px;
    background:#fafafa;
    border:1px solid #e0e0e0;
  ">
    <input
      [(ngModel)]="search"
      name="search"
      placeholder="üîé Buscar por t√≠tulo o autor"
      style="flex:2; min-width:180px; padding:6px 8px; border-radius:4px; border:1px solid #c4c4c4; font-size:13px;"
    />
    <select
      [(ngModel)]="filterCategoriaId"
      name="filterCategoriaId"
      style="flex:1; min-width:160px; padding:6px 8px; border-radius:4px; border:1px solid #c4c4c4; font-size:13px;"
    >
      <option value="">Todas las categor√≠as</option>
      <option *ngFor="let c of categorias" [value]="c.id">{{ c.nombre }}</option>
    </select>
    <button
      type="button"
      (click)="search=''; filterCategoriaId='';"
      style="
        padding:6px 10px;
        border-radius:4px;
        border:1px solid #bdbdbd;
        background:white;
        cursor:pointer;
        font-size:13px;
      "
    >
      Limpiar filtros
    </button>
  </section>

  <!-- ================= FORMULARIO REACTIVO ================= -->
  <section style="
    margin:16px 0;
    padding:14px 16px;
    border-radius:6px;
    background:#fffde7;
    border:1px solid #ffe082;
  ">
    <h3 style="margin:0 0 10px; font-size:18px;">
      {{ editando ? 'Editar libro' : 'Agregar libro' }}
    </h3>

    <form
      [formGroup]="formLibro"
      (ngSubmit)="guardar()"
      style="
        display:grid;
        grid-template-columns: 2fr 2fr 1fr 1.3fr auto;
        gap:8px 10px;
        align-items:flex-start;
      "
    >
      <!-- id oculto -->
      <input type="hidden" formControlName="id" />

      <!-- T√çTULO -->
      <div style="display:flex; flex-direction:column;">
        <label style="font-size:12px; margin-bottom:2px;">T√≠tulo *</label>
        <input
          formControlName="titulo"
          placeholder="T√≠tulo"
          style="padding:6px 8px; border-radius:4px; border:1px solid #c4c4c4; font-size:13px;"
        />
        <small
          *ngIf="titulo?.invalid && (titulo?.touched || titulo?.dirty)"
          style="color:#dc2626; font-size:11px; margin-top:2px;"
        >
          <span *ngIf="titulo?.errors?.['required']">El t√≠tulo es obligatorio. </span>
          <span *ngIf="titulo?.errors?.['minlength']">M√≠nimo 3 caracteres.</span>
        </small>
      </div>

      <!-- AUTOR -->
      <div style="display:flex; flex-direction:column;">
        <label style="font-size:12px; margin-bottom:2px;">Autor *</label>
        <input
          formControlName="autor"
          placeholder="Autor"
          style="padding:6px 8px; border-radius:4px; border:1px solid #c4c4c4; font-size:13px;"
        />
        <small
          *ngIf="autor?.invalid && (autor?.touched || autor?.dirty)"
          style="color:#dc2626; font-size:11px; margin-top:2px;"
        >
          <span *ngIf="autor?.errors?.['required']">El autor es obligatorio. </span>
          <span *ngIf="autor?.errors?.['minlength']">M√≠nimo 3 caracteres.</span>
        </small>
      </div>

      <!-- A√ëO -->
      <div style="display:flex; flex-direction:column;">
        <label style="font-size:12px; margin-bottom:2px;">A√±o *</label>
        <input
          formControlName="anio"
          type="number"
          placeholder="A√±o"
          style="padding:6px 8px; border-radius:4px; border:1px solid #c4c4c4; font-size:13px; text-align:center;"
        />
        <small
          *ngIf="anio?.invalid && (anio?.touched || anio?.dirty)"
          style="color:#dc2626; font-size:11px; margin-top:2px;"
        >
          <span *ngIf="anio?.errors?.['required']">El a√±o es obligatorio. </span>
          <span *ngIf="anio?.errors?.['min']">A√±o m√≠nimo 1900. </span>
          <span *ngIf="anio?.errors?.['max']">El a√±o no puede ser mayor al actual.</span>
        </small>
      </div>

      <!-- CATEGOR√çA -->
      <div style="display:flex; flex-direction:column;">
        <label style="font-size:12px; margin-bottom:2px;">Categor√≠a *</label>
        <select
          formControlName="categoriaId"
          style="padding:6px 8px; border-radius:4px; border:1px solid #c4c4c4; font-size:13px;"
        >
          <option value="">-- Categor√≠a --</option>
          <option *ngFor="let c of categorias" [value]="c.id">{{ c.nombre }}</option>
        </select>
        <small
          *ngIf="categoriaId?.invalid && (categoriaId?.touched || categoriaId?.dirty)"
          style="color:#dc2626; font-size:11px; margin-top:2px;"
        >
          Selecciona una categor√≠a.
        </small>
      </div>

      <!-- BOTONES -->
      <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
        <button
          type="submit"
          [disabled]="formLibro.invalid"
          [style.opacity]="formLibro.invalid ? '0.6' : '1'"
          style="
            padding:6px 12px;
            border-radius:4px;
            border:none;
            cursor:pointer;
            font-size:13px;
            background:#2e7d32;
            color:white;
          "
        >
          {{ editando ? 'Actualizar' : 'Agregar' }}
        </button>
        <button
          type="button"
          (click)="cancelarEdicion()"
          style="
            padding:4px 10px;
            border-radius:4px;
            border:1px solid #bdbdbd;
            background:white;
            cursor:pointer;
            font-size:12px;
          "
        >
          Limpiar
        </button>
      </div>
    </form>
  </section>

  <!-- ================= LISTA ================= -->
  <section style="
    border-radius:6px;
    border:1px solid #e0e0e0;
    background:white;
    overflow-x:auto;
  ">

    <!-- Mensaje de carga -->
    <p *ngIf="cargando" style="font-size:13px; opacity:.7; margin:8px 12px;">
      Cargando libros desde Firestore...
    </p>

    <table cellpadding="6" style="border-collapse:collapse; width:100%; font-size:13px;">
      <thead style="background:#f5f5f5;">
        <tr>
          <th style="text-align:left; border-bottom:1px solid #ddd;">T√≠tulo</th>
          <th style="text-align:left; border-bottom:1px solid #ddd;">Autor</th>
          <th style="text-align:center; border-bottom:1px solid #ddd; width:70px;">A√±o</th>
          <th style="text-align:center; border-bottom:1px solid #ddd;">Categor√≠a</th>
          <th style="text-align:center; border-bottom:1px solid #ddd; width:90px;">Estado</th>
          <th style="text-align:center; border-bottom:1px solid #ddd; width:260px;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let l of librosFiltrados; trackBy: trackById"
          [ngStyle]="l.estado === 'prestado' ? {'background-color': '#fff3e0'} : null"
          style="border-bottom:1px solid #eee;"
        >
          <td>{{ l.titulo }}</td>
          <td>{{ l.autor }}</td>
          <td style="text-align:center">{{ l.anio }}</td>
          <td style="text-align:center">
            {{ getNombreCategoria(l.categoriaId) }}
          </td>
          <td style="text-align:center">{{ l.estado | estadoLibro }}</td>
          <td style="white-space:nowrap; text-align:center;">

            <a
              [routerLink]="['/libros', l.id]"
              style="margin-right:6px; font-size:12px; text-decoration:none; color:#1565c0;"
            >
              Ver detalle
            </a>

            <button
              type="button"
              (click)="editar(l)"
              style="
                padding:3px 8px;
                margin-right:4px;
                font-size:12px;
                border-radius:4px;
                border:1px solid #1976d2;
                background:#e3f2fd;
                cursor:pointer;
              "
            >
              Editar
            </button>

            <button
              type="button"
              (click)="cambiarEstado(l, l.estado === 'disponible' ? 'prestado' : 'disponible')"
              style="
                padding:3px 8px;
                margin-right:4px;
                font-size:12px;
                border-radius:4px;
                border:1px solid #8d6e63;
                background:#efebe9;
                cursor:pointer;
              "
            >
              {{ l.estado === 'disponible' ? 'Marcar prestado' : 'Marcar disponible' }}
            </button>

            <button
              type="button"
              (click)="borrar(l.id)"
              style="
                padding:3px 8px;
                font-size:12px;
                border-radius:4px;
                border:1px solid #d32f2f;
                background:#ffebee;
                cursor:pointer;
              "
            >
              Eliminar
            </button>
          </td>
        </tr>

        <tr *ngIf="!cargando && libros.length > 0 && librosFiltrados.length === 0">
          <td colspan="6" style="text-align:center; padding:12px; font-size:13px; opacity:.7;">
            No hay resultados que coincidan con el filtro.
          </td>
        </tr>
      </tbody>
    </table>
  </section>

</section>
